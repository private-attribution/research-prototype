#!/usr/bin/env bash
# This is a pre-commit hook that validates code formatting.
#
# Install this by running the script with an argument of "install",
# which installs a symlink to .git/hooks/precommit:
# $ ln -s ../../hooks/pre-commit .git/hooks/pre-commit

root="$(git rev-parse --show-toplevel 2>/dev/null)"

set -e

# Some sanity checking.
[[ -n "$root" ]]

# Installation.
if [[ "$1" == "install" ]]; then
    hook="$root"/.git/hooks/pre-commit
    if [[ ! -e "$hook" ]]; then
        ln -s ../../pre-commit "$hook"
        echo "Installed git pre-commit hook at $hook"
    else
        echo "Hook already installed"
    fi
    exit
fi

# Check formatting.
stashfile=$(mktemp .pre-commit.stashXXXXXX)
trap 'set +e;git stash pop -q; rm -f "$stashfile"' EXIT
git stash push -k -u -q -m "pre-commit stash"

error() {
   echo "-----------------------"
   echo "$@"
   exit 1
}

VENV="$root/.venv/bin"
pyrun() {
    x="$1"
    shift
    if ! [[ -d "$VENV" ]]; then
        python3 -m venv "${VENV%/*}"
    fi
    if ! [[ -x "$VENV/$x" ]]; then
        "$VENV/pip" install -r "$root/requirements.txt"
    elif [[ "$root/requirements.txt" -nt "$VENV/$x" ]]; then
        "$VENV/pip" install --upgrade -r "$root/requirements.txt"
    fi
    echo "Run: $x $@"
    "$x" "$@"
}

pyrun flake518 . || error "Python flake8 formatting errors."

pyrun black --check --diff . || error "Python Black formatting errors. Run \`black .\` to fix."

pyrun isort --check --diff . || error "Python isort import ordering errors. Run \`isort .\` to fix."
